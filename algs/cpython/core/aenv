if [ "$1" == "" ]; then
    exit 0
fi
if [ "$2" == "" ]; then
    exit 0
fi

###########################################################
# create temporary dir and cd into it
###########################################################
TMPDIR=__tmp
while [ -d $TMPDIR ]
do
TMPDIR="_${TMPDIR}"
done

###########################################################
# compiler query
###########################################################
if [ "$2" == "--compiler" ]; then
    if [ "$1" == "" ]; then
        echo "bad"
        exit 1
    fi
    mkdir $TMPDIR
    cd $TMPDIR
    cat <<HEREVAR >aconf.c
#include <stdio.h>
#include <string.h>

/* prepare environment */
#define AE_UNKNOWN 0
#define AE_GNUC 1
#define AE_SUNC 2
#define AE_MSVC 3
#define AE_COMPILER AE_UNKNOWN
/* try to determine compiler */
#ifdef __GNUC__
#undef AE_COMPILER
#define AE_COMPILER AE_GNUC
#endif
#ifdef __SUNPRO_C
#undef AE_COMPILER
#define AE_COMPILER AE_SUNC
#endif
#ifdef _MSC_VER
#undef AE_COMPILER
#define AE_COMPILER AE_MSVC
#endif
int main(int argc, char **argv)
{
#if AE_COMPILER==AE_GNUC
    printf("gcc");
#elif AE_COMPILER==AE_SUNC
    printf("sunstudio");
#elif AE_COMPILER==AE_MSVC
    printf("msvc");
#else
    printf("unknown");
#endif
    return 0;
}

HEREVAR
    $1 $3 aconf.c
    if [ $? -ne 0 ]; then
        echo "bad"
        exit 1
    fi 
    if [ -f "a.out" ]; then
        echo `./a.out`
    elif [ -f "a.exe" ]; then
        echo `./a.exe`
    fi
    cd ..
    rm -rf $TMPDIR
    exit 0
fi


###########################################################
# CPU query
###########################################################
if [ "$2" == "--cpu" ]; then
    UNAME_P=`uname -p`
    UNAME_M=`uname -m`
    UNAME="$UNAME_P $UNAME_M"
    
    # check for x86-64 first
    if [[ $UNAME == *x86_64* ]]; then
        echo "x86_64"
        exit 0
    fi
    if [[ $UNAME == *amd64* ]]; then
        echo "x86_64"
        exit 0
    fi
    
    # check for x86 (checked AFTER x86_64)
    if [[ $UNAME == *x86* ]]; then
        echo "x86"
        exit 0
    fi
    if [[ $UNAME == *i686* ]]; then
        echo "x86"
        exit 0
    fi
    if [[ $UNAME == *i386* ]]; then
        echo "x86"
        exit 0
    fi
    
    # check for SPARC
    if [[ $UNAME == *sparc* ]]; then
        echo "sparc"
        exit 0
    fi
    
    # unknown
    echo unknown
    exit 0
fi


###########################################################
# stdint.h query
###########################################################
if [ "$2" == "--have-stdint" ]; then
    if [ "$1" == "" ]; then
        echo "no"
        exit 0
    fi
    mkdir $TMPDIR
    cd $TMPDIR
    cat <<HEREVAR >aconf.c
#include <stdint.h>
int main(int argc, char **argv) { int32_t a; int64_t b; return 0; }

HEREVAR
    $1 $3 aconf.c > /dev/null 2> /dev/null
    if [ $? -ne 0 ]; then
        RETVAL="no"
    else
        RETVAL="yes"
    fi
    cd ..
    rm -rf $TMPDIR
    echo "$RETVAL"
    exit 0
fi


###########################################################
# sizeof query
###########################################################
if [ "$2" == "--sizeof" ]; then
    if [ "$1" == "" ]; then
        echo "no"
        exit 0
    fi
    mkdir $TMPDIR
    cd $TMPDIR
    cat <<HEREVAR >aconf.c
int main(int argc, char **argv) { $3 v; printf("%d", (int)(sizeof(v))); return 0; }

HEREVAR
    $1 $4 aconf.c > /dev/null 2> /dev/null
    if [ $? -ne 0 ]; then
        RETVAL="0"
    else
        if [ -f "a.out" ]; then
            RETVAL=`./a.out`
        elif [ -f "a.exe" ]; then
            RETVAL=`./a.exe`
        else
            RETVAL="0"
        fi
    fi
    cd ..
    rm -rf $TMPDIR
    echo "$RETVAL"
    exit 0
fi


###########################################################
# int32_t query (returns signed integer type whose size is 32 bits)
###########################################################
if [ "$2" == "--int32_t" ]; then
    if [ `$0 $1 --sizeof int $3` == "4" ]; then
        echo "int"
        exit 0
    fi
    echo ""
    exit 1
fi


###########################################################
# int64_t query (returns signed integer type whose size is 64 bits)
###########################################################
if [ "$2" == "--int64_t" ]; then
    if [ `$0 $1 --sizeof "long long int" $3` == "8" ]; then
        echo "long long int"
        exit 0
    fi
    if [ `$0 $1 --sizeof "long" $3` == "8" ]; then
        echo "long"
        exit 0
    fi
    echo ""
    exit 1
fi


